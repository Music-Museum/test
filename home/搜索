-- Get clipboard content first
try
	set rawClipboard to the clipboard as text
on error
	set rawClipboard to ""
end try

set trimmedClipboardText to ""
if rawClipboard is not "" then
	-- Trim leading/trailing whitespace
	set trimmedClipboardText to do shell script "echo " & quoted form of rawClipboard & " | sed -E 's/^[[:space:]]+|[[:space:]]+$//g'"
end if

-- Check if the trimmed clipboard content is a URL
if trimmedClipboardText is not "" then
	set isLikelyURL to false
	set lowerTrimmedText to do shell script "echo " & quoted form of trimmedClipboardText & " | tr '[:upper:]' '[:lower:]'" -- Convert to lowercase for checks
	
	-- 1. Check for http:// or https:// prefix
	if (lowerTrimmedText begins with "http://") or (lowerTrimmedText begins with "https://") then
		set isLikelyURL to true
	else
		-- 2. Check for common TLDs (and ensure it's not just a filename like "archive.zip")
		if not (lowerTrimmedText contains " ") and not (lowerTrimmedText contains "/") then
			set tlds to {".com", ".cn", ".ai", ".net", ".org", ".io", ".dev", ".app", ".me", ".tv", ".co", ".uk", ".jp", ".de", ".info", ".biz"}
			repeat with currentTLD in tlds
				if lowerTrimmedText ends with currentTLD then
					if length of lowerTrimmedText > length of currentTLD then
						set isLikelyURL to true
						exit repeat
					end if
				end if
			end repeat
		end if
	end if
	
	if isLikelyURL then
		set urlToOpen to trimmedClipboardText
		if not ((urlToOpen begins with "http://") or (urlToOpen begins with "https://")) then
			set urlToOpen to "http://" & urlToOpen
		end if
		
		try
			do shell script "open -a 'Google Chrome' " & quoted form of urlToOpen
			return -- Successfully opened URL, so exit the script
		on error errMsg number errNum
			-- display dialog "æ— æ³•ç›´æ¥æ‰“å¼€é“¾æ¥: " & urlToOpen & return & return & errMsg buttons {"å¥½çš„"} default button "å¥½çš„" with icon caution
			-- Fall through to the menu
		end try
	end if
end if

-- If clipboard was empty, not a URL, or direct URL opening failed, show the menu
set userChoice to choose from list {"ğŸ” ä»å‰ªè´´æ¿æœç´¢ Google", "ğŸ“º æ‰“å¼€ YouTube", "ğŸ“ ç©ºåœ°å€ï¼ˆå¤‡ç”¨ï¼‰"} with prompt "è¯·é€‰æ‹©ä¸€ä¸ªæ“ä½œï¼š" default items {"ğŸ” ä»å‰ªè´´æ¿æœç´¢ Google"} with title "å‰ªè´´æ¿åŠ©æ‰‹"

if userChoice is false then return -- ç”¨æˆ·å–æ¶ˆ

set chosenOption to item 1 of userChoice

if chosenOption is "ğŸ” ä»å‰ªè´´æ¿æœç´¢ Google" then
	set searchText to ""
	set useClipboardForSearch to true
	
	if trimmedClipboardText is "" then
		set dialogResult to display dialog "å‰ªè´´æ¿ä¸­æ— å¯ç”¨æ–‡æœ¬ï¼Œè¯·è¾“å…¥æœç´¢å†…å®¹ï¼š" default answer "" with icon note buttons {"å–æ¶ˆ", "æœç´¢"} default button "æœç´¢"
		if button returned of dialogResult is "æœç´¢" then
			set searchText to text returned of dialogResult
			set useClipboardForSearch to false
		else
			return -- User cancelled input
		end if
	else if (length of trimmedClipboardText) > 50 then
		set confirmDialog to display dialog "å‰ªè´´æ¿å†…å®¹è¶…è¿‡ 50 å­—ç¬¦ï¼Œå¯èƒ½ä¸æ˜¯ä½ æƒ³æœç´¢çš„å†…å®¹ï¼š" & return & return & "\"" & trimmedClipboardText & "\"" & return & return & "æ˜¯å¦ä½¿ç”¨å®ƒè¿›è¡Œæœç´¢ï¼Ÿ" with icon caution buttons {"è¾“å…¥æ–°çš„å†…å®¹", "ç»§ç»­ä½¿ç”¨å‰ªè´´æ¿"} default button "è¾“å…¥æ–°çš„å†…å®¹"
		if button returned of confirmDialog is "è¾“å…¥æ–°çš„å†…å®¹" then
			set dialogResult to display dialog "è¯·è¾“å…¥æœç´¢å…³é”®å­—ï¼š" default answer "" with icon note buttons {"å–æ¶ˆ", "æœç´¢"} default button "æœç´¢"
			if button returned of dialogResult is "æœç´¢" then
				set searchText to text returned of dialogResult
				set useClipboardForSearch to false
			else
				return -- User cancelled input
			end if
		else
			set searchText to trimmedClipboardText
		end if
	else
		set searchText to trimmedClipboardText
	end if
	
	if searchText is "" then
		display dialog "æœªæä¾›æœç´¢å†…å®¹ã€‚" buttons {"å¥½"} default button "å¥½" with icon stop
		return
	end if
	
	set encodedText to do shell script "python3 -c 'import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1]))' " & quoted form of searchText
	set googleURL to "https://www.google.com/search?q=" & encodedText
	do shell script "open -a 'Google Chrome' " & quoted form of googleURL
	
else if chosenOption is "ğŸ“º æ‰“å¼€ YouTube" then
	do shell script "open -a 'Google Chrome' https://www.youtube.com"
	
else if chosenOption is "ğŸ“ ç©ºåœ°å€ï¼ˆå¤‡ç”¨ï¼‰" then
	display dialog "è¯¥åŠŸèƒ½å°šæœªå®ç°ï¼Œå¯ç”¨äºæ‰©å±•ã€‚" buttons {"å¥½"} default button "å¥½" with icon note
end if
